<html>
<head>
  <title>U2F demo</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="client/js/u2f.js"></script>
</head>
<body>

<script>

  function registerRequest() {

    var data = {
      name: 'joe'
    };
    $.ajax({
      url: "/api/accounts/register",
      type: 'POST',
      data: data,
      success: function (registerRequest) {
        console.log('Rest Api registerRequest response: %j', registerRequest);

        $.ajax({
          url: "/api/tokens/register",
          type: 'POST',
          data: {
            appId: registerRequest.appId,
            challenge: registerRequest.registerRequests[0].challenge
          },
          success: function (deviceResponse) {
            console.log('Device register response: %j', deviceResponse);
            registerResponse({
              version: registerRequest.registerRequests[0].version,
              challenge: registerRequest.registerRequests[0].challenge,
              clientData: deviceResponse.clientData,
              registrationData: deviceResponse.registrationData,
              keyHandle: deviceResponse.keyHandle
            }, function(registerResponse) {

              console.log('Rest Api registerResponse response: %j', registerResponse);
            });
          },
          error: function (data, textStatus) {
            console.log('error');
          }
        });

//        u2f.register(request.appId, [
//          {version: request.registerRequests[0].version, challenge: request.registerRequests[0].challenge}
//        ], [], function(deviceResponse) {
//          console.log(deviceResponse);
//          registerResponse(deviceResponse, function(response) {
//            console.log(response);
//          });
//        }, 10);
      },
      error: function (data, textStatus) {
        console.log('error');
//        callback(textStatus, JSON.parse(data.responseText).error)
      }
    });
  }

  function registerResponse(deviceResponse, callback) {

    var data = {
      name: 'joe',
      challenge: deviceResponse.challenge,
      clientData: deviceResponse.clientData,
      registrationData: deviceResponse.registrationData,
      keyHandle: deviceResponse.keyHandle,
      version: deviceResponse.version
    };
    $.ajax({
      url: "/api/accounts/registerResponse",
      type: 'POST',
      data: data,
      success: function (response) {
        callback(response);
      },
      error: function (data, textStatus) {
        console.log('error');
//        callback(textStatus, JSON.parse(data.responseText).error)
      }
    });
  }

  function signRequest() {

    var data = {
      name: 'joe',
      password: 'xx'
    };
    $.ajax({
      url: "/api/accounts/sign",
      type: 'POST',
      data: data,
      success: function (signRequest) {
        console.log('Rest Api signRequest response: %j', signRequest);

        $.ajax({
          url: "/api/tokens/sign",
          type: 'POST',
          data: {
            appId: signRequest.appId,
            challenge: signRequest.challenge,
            keyHandle: signRequest.registeredKeys[0].keyHandle
          },
          success: function (deviceResponse) {
            console.log('Device sign response: %j', deviceResponse);
            signResponse(signRequest.challenge, {
              clientData: deviceResponse.clientData,
              signatureData: deviceResponse.signatureData,
              keyHandle: deviceResponse.keyHandle
            }, function(signResponse) {

              console.log('Rest Api signResponse response: %j', signResponse);
            });
          },
          error: function (data, textStatus) {
            console.log('error');
          }
        });

//        u2f.sign(request.appId, request.challenge, request.registeredKeys, function(deviceResponse) {
//          console.log(deviceResponse);
//          signResponse(request.challenge, deviceResponse, function(response) {
//            console.log(response);
//          });
//        }, 10);
      },
      error: function (data, textStatus) {
        console.log('error');
//        callback(textStatus, JSON.parse(data.responseText).error)
      }
    });
  }

  function signResponse(challenge, deviceResponse, callback) {

    var data = {
      challenge: challenge,
      clientData: deviceResponse.clientData,
      keyHandle: deviceResponse.keyHandle,
      signatureData: deviceResponse.signatureData
    };
    $.ajax({
      url: "/api/accounts/signInResponse",
      type: 'POST',
      data: data,
      success: function (response) {
        callback(response);
      },
      error: function (data, textStatus) {
        console.log('error');
//        callback(textStatus, JSON.parse(data.responseText).error)
      }
    });
  }
</script>

<div class="base">
  <button onclick="registerRequest()"> Register </button>
  <button onclick="signRequest()"> Sign-In </button>
</div>

</body>

</html>
